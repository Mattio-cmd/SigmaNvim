-- Set up completion using nvim_cmp with LSP source


local has_words_before = function()
  unpack = unpack or table.unpack
  local line, col = unpack(vim.api.nvim_win_get_cursor(0))
  return col ~= 0 and vim.api.nvim_buf_get_lines(0, line - 1, line, true)[1]:sub(col, col):match("%s") == nil
end

local luasnip = require("luasnip")
local cmp = require("cmp")

cmp.setup({

  snippet = {
    expand = function(args)
      luasnip.lsp_expand(args.body)
    end,
  },
  sources = {
    { name = 'nvim_lsp' },
    { name = 'luasnip' },
    { name = 'pyright' },
  },
  -- ... Your other configuration ...

  mapping = {

    -- ... Your other mappings ...

    ["<Tab>"] = cmp.mapping(function(fallback)
      if cmp.visible() then
        cmp.select_next_item()
      -- You could replace the expand_or_jumpable() calls with expand_or_locally_jumpable()
      -- that way you will only jump inside the snippet region
      elseif luasnip.expand_or_jumpable() then
        luasnip.expand_or_jump()
      elseif has_words_before() then
        cmp.complete()
      else
        fallback()
      end
    end, { "i", "s" }),

    ["<S-Tab>"] = cmp.mapping(function(fallback)
      if cmp.visible() then
        cmp.select_prev_item()
      elseif luasnip.jumpable(-1) then
        luasnip.jump(-1)
      else
        fallback()
      end
    end, { "i", "s" }),

    -- ... Your other mappings ...
  },

  -- ... Your other configuration ...
})


--nvim_lsp.flow.setup {
  --on_attach = on_attach,
  --capabilities = capabilities
--}

--nvim_lsp.tsserver.setup {
  --on_attach = on_attach,
  --filetypes = { "js", "javascriptreact", "javascript", "typescript", "typescriptreact", "typescript.tsx" },
  --capabilities = capabilities
--}

--nvim_lsp.diagnosticls.setup {
  --on_attach = on_attach,
  --filetypes = { 'js', 'javascript', 'javascriptreact', 'json', 'typescript', 'typescriptreact', 'css', 'less', 'scss', 'markdown', 'pandoc' },
  --init_options = {
    --linters = {
      --eslint = {
        --command = 'eslint_d',
        --rootPatterns = { '.git', '.js' },
        --debounce = 100,
        --args = { '--stdin', '--stdin-filename', '%filepath', '--format', 'json' },
        --sourceName = 'eslint_d',
        --parseJson = {
          --errorsRoot = '[0].messages',
          --line = 'line',
          --column = 'column',
          --endLine = 'endLine',
          --endColumn = 'endColumn',
          --message = '[eslint] ${message} [${ruleId}]',
          --security = 'severity'
        --},
        --securities = {
          --[2] = 'error',
          --[1] = 'warning'
        --}
      --},
    --},
    --filetypes = {
      --javascript = 'eslint',
      --javascriptreact = 'eslint',
      --typescript = 'eslint',
      --typescriptreact = 'eslint',
    --},
    --formatters = {
      --eslint_d = {
        --command = 'eslint_d',
        --rootPatterns = { '.git' },
        --args = { '--stdin', '--stdin-filename', '%filename', '--fix-to-stdout' },
        --rootPatterns = { '.git', '.js' },
      --},
      --prettier = {
        --command = 'prettier_d_slim',
        --rootPatterns = { '.git' },
        ---- requiredFiles: { 'prettier.config.js' },
        --args = { '--stdin', '--stdin-filepath', '%filename' }
      --}
    --},
    --formatFiletypes = {
      --css = 'prettier',
      --javascript = 'prettier',
      --javascriptreact = 'prettier',
      --json = 'prettier',
      --scss = 'prettier',
      --less = 'prettier',
      --typescript = 'prettier',
      --typescriptreact = 'prettier',
      --markdown = 'prettier',
    --}
  --}
--}

-- icon
vim.lsp.handlers["textDocument/publishDiagnostics"] = vim.lsp.with(
  vim.lsp.diagnostic.on_publish_diagnostics, {
    underline = true,
    -- This sets the spacing and the prefix, obviously.
    virtual_text = {
      spacing = 4,
      prefix = 'ï†²'
    }
  }
)


-- The following is some code i coppied
-- https://github.com/voyeg3r/nvim/blob/master/lua/plugins/config/cmp.lua
